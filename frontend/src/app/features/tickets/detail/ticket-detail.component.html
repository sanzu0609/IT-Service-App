<section class="flex flex-col gap-4">
  <a [routerLink]="['/tickets']" class="text-sm font-semibold text-emerald-700 hover:underline">
    &larr; Back to tickets
  </a>

  <div *ngIf="loading()" class="rounded-lg border border-slate-200 bg-white p-6 text-sm text-slate-500 shadow-sm">
    Loading ticket details...
  </div>

  <div *ngIf="error()" class="rounded-lg border border-rose-200 bg-rose-50 p-6 text-sm text-rose-700 shadow-sm">
    {{ error() }}
  </div>

  <div *ngIf="ticket() as current" class="grid gap-4 lg:grid-cols-3">
    <section class="lg:col-span-2 space-y-4">
      <article class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Ticket #{{ current.ticketNumber }}</p>
            <h1 class="mt-1 text-2xl font-semibold text-slate-900">{{ current.subject }}</h1>
          </div>
          <div class="flex flex-col items-end gap-2">
            <app-ticket-status-chip [status]="current.status"></app-ticket-status-chip>
            <a
              *ngIf="canEditTicket()"
              class="text-xs font-semibold text-emerald-700 hover:underline"
              [routerLink]="['/tickets', current.id, 'edit']"
            >
              Edit ticket
            </a>
          </div>
        </div>
        <p class="mt-4 text-sm leading-relaxed text-slate-700">{{ current.description }}</p>
        <dl class="mt-6 grid gap-3 text-sm text-slate-600 sm:grid-cols-2">
          <div>
            <dt class="font-semibold text-slate-500">Priority</dt>
            <dd class="mt-1 text-slate-800">{{ current.priority }}</dd>
          </div>
          <div>
            <dt class="font-semibold text-slate-500">SLA</dt>
            <dd class="mt-1">
              <app-sla-badge [flag]="current.slaFlag"></app-sla-badge>
            </dd>
          </div>
          <div>
            <dt class="font-semibold text-slate-500">Response deadline</dt>
            <dd class="mt-1 text-slate-800">
              {{ current.slaResponseDeadline | dateUtc }}
              <span
                *ngIf="current.slaResponseDeadline"
                class="block text-xs text-slate-500"
              >
                {{ current.slaResponseDeadline | relativeTime }}
              </span>
            </dd>
          </div>
          <div>
            <dt class="font-semibold text-slate-500">Resolution deadline</dt>
            <dd class="mt-1 text-slate-800">
              {{ current.slaResolutionDeadline | dateUtc }}
              <span
                *ngIf="current.slaResolutionDeadline"
                class="block text-xs text-slate-500"
              >
                {{ current.slaResolutionDeadline | relativeTime }}
              </span>
            </dd>
          </div>
          <div>
            <dt class="font-semibold text-slate-500">Reporter</dt>
            <dd class="mt-1 text-slate-800">
              {{ current.reporter?.fullName || current.reporter?.username || 'Unknown reporter' }}
            </dd>
          </div>
          <div>
            <dt class="font-semibold text-slate-500">Assignee</dt>
            <dd class="mt-1 text-slate-800">
              {{ current.assignee?.fullName || current.assignee?.username || 'Unassigned' }}
            </dd>
          </div>
          <div>
            <dt class="font-semibold text-slate-500">Created</dt>
            <dd class="mt-1 text-slate-800">{{ current.createdAt | date: 'medium' }}</dd>
          </div>
          <div>
            <dt class="font-semibold text-slate-500">Updated</dt>
            <dd class="mt-1 text-slate-800">{{ current.updatedAt | date: 'medium' }}</dd>
          </div>
        </dl>
      </article>

      <article class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm">
        <header class="flex flex-wrap items-center justify-between gap-3">
          <h2 class="text-base font-semibold text-slate-900">Comments</h2>
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">
            {{ visibleComments().length }} visible
          </span>
        </header>

        <div *ngIf="commentsLoading()" class="mt-3 rounded-md border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-500">
          Loading comments...
        </div>

        <div *ngIf="commentError()" class="mt-3 rounded-md border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
          {{ commentError() }}
        </div>

        <ng-container *ngIf="!commentsLoading()">
          <div *ngIf="visibleComments().length === 0" class="mt-4 rounded-md border border-dashed border-slate-200 bg-slate-50 px-4 py-6 text-center text-sm text-slate-500">
            No comments yet.
          </div>

          <ul *ngIf="visibleComments() as comments" class="mt-4 space-y-3">
            <li *ngFor="let comment of comments; trackBy: trackComment" class="rounded-md border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <span class="text-sm font-semibold text-slate-800">
                  {{ comment.authorName || 'Unknown user' }}
                </span>
                <span class="text-xs text-slate-500">{{ comment.createdAt | date: 'short' }}</span>
              </div>
              <p class="mt-2 text-sm text-slate-700" [class.italic]="comment.isInternal">
                {{ comment.content }}
              </p>
              <span *ngIf="comment.isInternal" class="mt-2 inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-700">
                Internal note
              </span>
            </li>
          </ul>
        </ng-container>

        <ng-container *ngIf="canComment(); else commentSignIn">
          <form class="mt-6 space-y-3" [formGroup]="commentForm" (ngSubmit)="submitComment()">
            <div class="flex flex-col gap-2">
              <label class="text-sm font-semibold text-slate-700" for="ticket-comment">Add a comment</label>
              <textarea
                id="ticket-comment"
                class="min-h-[120px] w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200"
                placeholder="Share an update..."
                formControlName="content"
              ></textarea>
              <ng-container *ngIf="commentForm.controls.content.touched && commentForm.controls.content.invalid">
                <p class="text-xs text-rose-600" *ngIf="commentForm.controls.content.hasError('required')">
                  Comment content is required.
                </p>
                <p class="text-xs text-rose-600" *ngIf="commentForm.controls.content.hasError('maxlength')">
                  Comment cannot exceed 2000 characters.
                </p>
              </ng-container>
            </div>

            <label *ngIf="canMarkInternal()" class="flex items-center gap-2 text-sm text-slate-700">
              <input
                type="checkbox"
                formControlName="isInternal"
                class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500"
              />
              Internal (only staff can view)
            </label>
            <p *ngIf="!canMarkInternal()" class="text-xs text-slate-500">Comments you add will be visible to staff.</p>

            <div class="flex items-center gap-3">
              <button
                type="submit"
                class="inline-flex items-center rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-500 disabled:opacity-50"
                [disabled]="commentSubmitting()"
              >
                {{ commentSubmitting() ? 'Posting...' : 'Post comment' }}
              </button>
              <span *ngIf="commentSubmitting()" class="text-xs text-slate-500">Submitting comment...</span>
            </div>
          </form>
        </ng-container>
        <ng-template #commentSignIn>
          <div class="mt-6 rounded border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-500">
            Sign in to add comments to this ticket.
          </div>
        </ng-template>
      </article>
    </section>

    <aside class="space-y-4">
      <section class="rounded-lg border border-slate-200 bg-white p-6 text-sm text-slate-600 shadow-sm">
        <h2 class="text-base font-semibold text-slate-900">Change Status</h2>

        <div *ngIf="!canChangeStatus()" class="mt-3 rounded border border-dashed border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-500">
          You do not have permission to change the status of this ticket.
        </div>

        <ng-container *ngIf="canChangeStatus()">
          <div *ngIf="statusMessage()" class="mt-3 rounded border border-emerald-200 bg-emerald-50 px-4 py-2 text-xs font-semibold text-emerald-700">
            {{ statusMessage() }}
          </div>
          <div *ngIf="statusError()" class="mt-3 rounded border border-rose-200 bg-rose-50 px-4 py-2 text-xs font-semibold text-rose-700">
            {{ statusError() }}
          </div>

          <ng-container *ngIf="availableStatuses().length > 0; else noTransitions">
            <form class="mt-3 space-y-3" [formGroup]="statusForm" (ngSubmit)="changeStatus()">
              <div class="flex flex-col gap-2">
                <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="ticket-next-status">Next status</label>
                <select
                  id="ticket-next-status"
                  class="rounded border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200"
                  formControlName="toStatus"
                >
                  <option *ngFor="let status of availableStatuses()" [value]="status">{{ status }}</option>
                </select>
                <p *ngIf="statusForm.controls.toStatus.touched && statusForm.controls.toStatus.invalid" class="text-xs text-rose-600">
                  Please select a valid status.
                </p>
              </div>

              <div class="flex flex-col gap-2">
                <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="ticket-status-note">Note (optional)</label>
                <textarea
                  id="ticket-status-note"
                  class="min-h-[100px] rounded border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200"
                  placeholder="Add any context for this change"
                  formControlName="note"
                ></textarea>
                <p
                  *ngIf="statusForm.controls.note.touched && statusForm.controls.note.hasError('maxlength')"
                  class="text-xs text-rose-600"
                >
                  Note cannot exceed 500 characters.
                </p>
              </div>

              <div class="flex flex-col gap-2" *ngIf="statusForm.controls.holdReason.enabled">
                <label class="text-xs font-semibold uppercase tracking-wide text-slate-500" for="ticket-hold-reason">
                  Hold reason
                </label>
                <input
                  id="ticket-hold-reason"
                  class="rounded border border-slate-300 px-3 py-2 text-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200 disabled:bg-slate-100"
                  placeholder="Explain why this ticket is on hold"
                  formControlName="holdReason"
                />
                <ng-container *ngIf="statusForm.controls.holdReason.touched && statusForm.controls.holdReason.invalid">
                  <p class="text-xs text-rose-600" *ngIf="statusForm.controls.holdReason.hasError('required')">
                    Hold reason is required when moving a ticket to On Hold.
                  </p>
                  <p class="text-xs text-rose-600" *ngIf="statusForm.controls.holdReason.hasError('maxlength')">
                    Hold reason cannot exceed 250 characters.
                  </p>
                </ng-container>
                <p class="text-xs text-slate-500">Required when the ticket is transitioned to On Hold.</p>
              </div>

              <button
                type="submit"
                class="w-full rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-500 disabled:opacity-50"
                [disabled]="statusSubmitting()"
              >
                {{ statusSubmitting() ? 'Updating...' : 'Update status' }}
              </button>
            </form>
          </ng-container>
          <ng-template #noTransitions>
            <div class="mt-3 rounded border border-dashed border-slate-200 bg-slate-50 px-4 py-3 text-xs text-slate-500">
              No further status transitions are available for this ticket.
            </div>
          </ng-template>
        </ng-container>
      </section>
    </aside>
  </div>
</section>
