<section class="flex flex-col gap-4">
  <a routerLink="['/tickets']" class="text-sm font-semibold text-emerald-700 hover:underline">
    ← Back to tickets
  </a>

  <div *ngIf="loading()" class="rounded-lg border border-slate-200 bg-white p-6 text-sm text-slate-500 shadow-sm">
    Loading ticket details...
  </div>

  <div *ngIf="error()" class="rounded-lg border border-rose-200 bg-rose-50 p-6 text-sm text-rose-700 shadow-sm">
    {{ error() }}
  </div>

  <div *ngIf="ticket() as current" class="grid gap-4 lg:grid-cols-3">
    <section class="lg:col-span-2 space-y-4">
      <article class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm">
        <div class="flex flex-wrap items-start justify-between gap-4">
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Ticket #{{ current.ticketNumber }}</p>
            <h1 class="mt-1 text-2xl font-semibold text-slate-900">{{ current.subject }}</h1>
          </div>
          <app-ticket-status-chip [status]="current.status"></app-ticket-status-chip>
        </div>
        <p class="mt-4 text-sm leading-relaxed text-slate-700">{{ current.description }}</p>
        <dl class="mt-6 grid gap-3 text-sm text-slate-600 sm:grid-cols-2">
          <div>
            <dt class="font-semibold text-slate-500">Priority</dt>
            <dd class="mt-1 text-slate-800">{{ current.priority }}</dd>
          </div>
          <div>
            <dt class="font-semibold text-slate-500">SLA</dt>
            <dd class="mt-1">
              <app-sla-badge [flag]="current.slaFlag"></app-sla-badge>
            </dd>
          </div>
          <div>
            <dt class="font-semibold text-slate-500">Reporter</dt>
            <dd class="mt-1 text-slate-800">{{ current.reporter.fullName || current.reporter.username }}</dd>
          </div>
          <div>
            <dt class="font-semibold text-slate-500">Assignee</dt>
            <dd class="mt-1 text-slate-800">
              {{ current.assignee?.fullName || current.assignee?.username || 'Unassigned' }}
            </dd>
          </div>
          <div>
            <dt class="font-semibold text-slate-500">Created</dt>
            <dd class="mt-1 text-slate-800">{{ current.createdAt | date: 'medium' }}</dd>
          </div>
          <div>
            <dt class="font-semibold text-slate-500">Updated</dt>
            <dd class="mt-1 text-slate-800">{{ current.updatedAt | date: 'medium' }}</dd>
          </div>
        </dl>
      </article>

      <article class="rounded-lg border border-slate-200 bg-white p-6 shadow-sm">
        <header class="flex flex-wrap items-center justify-between gap-3">
          <h2 class="text-base font-semibold text-slate-900">Comments</h2>
          <span class="text-xs font-semibold uppercase tracking-wide text-slate-400">
            {{ visibleComments().length }} visible
          </span>
        </header>

        <div *ngIf="commentsLoading()" class="mt-3 rounded-md border border-slate-200 bg-slate-50 px-4 py-3 text-sm text-slate-500">
          Loading comments...
        </div>

        <div *ngIf="commentError()" class="mt-3 rounded-md border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
          {{ commentError() }}
        </div>

        <ng-container *ngIf="!commentsLoading()">
          <div *ngIf="visibleComments().length === 0" class="mt-4 rounded-md border border-dashed border-slate-200 bg-slate-50 px-4 py-6 text-center text-sm text-slate-500">
            No comments yet.
          </div>

          <ul *ngIf="visibleComments() as comments" class="mt-4 space-y-3">
            <li *ngFor="let comment of comments; trackBy: trackComment" class="rounded-md border border-slate-200 bg-slate-50 px-4 py-3">
              <div class="flex flex-wrap items-center justify-between gap-2">
                <span class="text-sm font-semibold text-slate-800">
                  {{ comment.author.fullName || comment.author.username }}
                </span>
                <span class="text-xs text-slate-500">{{ comment.createdAt | date: 'short' }}</span>
              </div>
              <p class="mt-2 text-sm text-slate-700" [class.italic]="comment.isInternal">
                {{ comment.content }}
              </p>
              <span *ngIf="comment.isInternal" class="mt-2 inline-flex items-center rounded-full bg-amber-100 px-2 py-0.5 text-xs font-semibold text-amber-700">
                Internal note
              </span>
            </li>
          </ul>
        </ng-container>

        <form class="mt-6 space-y-3" [formGroup]="commentForm" (ngSubmit)="submitComment()">
          <div class="flex flex-col gap-2">
            <label class="text-sm font-semibold text-slate-700" for="ticket-comment">Add a comment</label>
            <textarea
              id="ticket-comment"
              class="min-h-[120px] w-full rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200"
              placeholder="Share an update..."
              formControlName="content"
            ></textarea>
            <p *ngIf="commentForm.controls.content.touched && commentForm.controls.content.invalid" class="text-xs text-rose-600">
              Comment content is required.
            </p>
          </div>

          <label *ngIf="canMarkInternal()" class="flex items-center gap-2 text-sm text-slate-700">
            <input type="checkbox" formControlName="isInternal" class="h-4 w-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500" />
            Internal (only staff can view)
          </label>
          <p *ngIf="!canMarkInternal()" class="text-xs text-slate-500">Comments you add will be visible to staff.</p>

          <div class="flex items-center gap-3">
            <button
              type="submit"
              class="inline-flex items-center rounded-md bg-emerald-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-500 disabled:opacity-50"
              [disabled]="commentSubmitting()"
            >
              {{ commentSubmitting() ? 'Posting...' : 'Post comment' }}
            </button>
            <span *ngIf="commentSubmitting()" class="text-xs text-slate-500">Submitting comment...</span>
          </div>
        </form>
      </article>
    </section>

    <aside class="space-y-4">
      <section class="rounded-lg border border-slate-200 bg-white p-6 text-sm text-slate-600 shadow-sm">
        <h2 class="text-base font-semibold text-slate-900">Status Workflow</h2>
        <p class="mt-2">Status change form will be delivered in FE-1.4.</p>
      </section>
    </aside>
  </div>
</section>
