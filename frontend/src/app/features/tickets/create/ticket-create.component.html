<!-- modal content template (shared by inline and route rendering) -->
<ng-template #modalContent>
  <section class="w-full max-w-3xl flex flex-col gap-4 bg-transparent">
    <header class="flex items-start justify-between">
      <div>
        <h1 class="text-2xl font-semibold text-slate-900">Create Ticket</h1>
        <p class="text-sm text-slate-600">Describe your issue and set an appropriate priority.</p>
      </div>
      <a *ngIf="!modal" class="text-sm font-semibold text-emerald-700 hover:underline" [routerLink]="['/tickets']">Back to list</a>
      <button *ngIf="modal" type="button" (click)="closed.emit(null)" class="text-sm font-semibold text-emerald-700 hover:underline">Close</button>
    </header>

    <form [formGroup]="form" (ngSubmit)="submit()" class="space-y-5 rounded-lg border border-slate-200 bg-white p-6 shadow-sm relative">
      <ng-container *ngIf="!modal; else modalClose">
        <a [routerLink]="['/tickets']" title="Close" aria-label="Close" class="absolute right-4 top-4 text-slate-400 hover:text-slate-600">
          <i class="fa-solid fa-xmark fa-lg"></i>
        </a>
      </ng-container>
      <ng-template #modalClose>
        <button type="button" title="Close" aria-label="Close" class="absolute right-4 top-4 text-slate-400 hover:text-slate-600" (click)="closed.emit(null)">
          <i class="fa-solid fa-xmark fa-lg"></i>
        </button>
      </ng-template>
    <div class="flex flex-col gap-2">
      <label class="text-sm font-semibold text-slate-700" for="ticket-subject">Subject</label>
      <input
        id="ticket-subject"
        class="rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200"
        placeholder="Short summary"
        formControlName="subject"
      />
      <ng-container *ngIf="showError('subject')">
        <p class="text-xs text-rose-600" *ngIf="form.controls.subject.hasError('required')">Subject is required.</p>
        <p class="text-xs text-rose-600" *ngIf="form.controls.subject.hasError('minlength')">Subject must be at least 5 characters.</p>
      </ng-container>
    </div>

    <div class="flex flex-col gap-2">
      <label class="text-sm font-semibold text-slate-700" for="ticket-description">Description</label>
      <textarea
        id="ticket-description"
        class="min-h-[160px] rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200"
        placeholder="Provide as much detail as possible"
        formControlName="description"
      ></textarea>
      <ng-container *ngIf="showError('description')">
        <p class="text-xs text-rose-600" *ngIf="form.controls.description.hasError('required')">Description is required.</p>
        <p class="text-xs text-rose-600" *ngIf="form.controls.description.hasError('minlength')">Description must be at least 10 characters.</p>
      </ng-container>
    </div>

    <div class="grid gap-4 md:grid-cols-2">
      <div class="flex flex-col gap-2">
        <label class="text-sm font-semibold text-slate-700" for="ticket-priority">Priority</label>
        <select
          id="ticket-priority"
          class="rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200"
          formControlName="priority"
        >
          <option *ngFor="let priority of priorities" [value]="priority">{{ priority }}</option>
        </select>
      </div>
      <div class="flex flex-col gap-2">
        <label class="text-sm font-semibold text-slate-700" for="ticket-category">Category</label>
        <select
          id="ticket-category"
          class="rounded-md border border-slate-300 px-3 py-2 text-sm shadow-sm focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-200"
          formControlName="category"
        >
          <option value="" disabled>Select category</option>
          <option *ngFor="let category of categories()" [value]="category.code">{{ category.label }}</option>
        </select>
        <p *ngIf="categoriesLoading()" class="text-xs text-slate-500">Loading categories...</p>
        <p *ngIf="categoriesError()" class="text-xs text-rose-600">{{ categoriesError() }}</p>
        <p *ngIf="showCategoryError()" class="text-xs text-rose-600">Please select a category.</p>
      </div>
    </div>

    <div *ngIf="error()" class="rounded border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
      {{ error() }}
    </div>

    <div class="flex items-center gap-3">
      <button
        type="submit"
        class="inline-flex items-center rounded-md bg-emerald-600 px-3 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-emerald-500 disabled:opacity-50"
        [disabled]="loading() || categoriesLoading() || forbidden()"
        title="Create ticket"
        aria-label="Create ticket"
      >
        <i class="fa-solid fa-plus"></i>
      </button>
      <span *ngIf="loading()" class="text-xs text-slate-500">Submitting...</span>
    </div>
    </form>
  </section>
</ng-template>

<!-- non-modal (route) rendering -->
<ng-container *ngIf="!modal; else modalBackdrop">
  <a [routerLink]="['/tickets']" class="fixed inset-0 bg-black/50"></a>
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <ng-container *ngTemplateOutlet="modalContent"></ng-container>
  </div>
</ng-container>

<!-- modal (inline) rendering -->
<ng-template #modalBackdrop>
  <div class="fixed inset-0 bg-black/50" (click)="closed.emit(null)"></div>
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <ng-container *ngTemplateOutlet="modalContent"></ng-container>
  </div>
</ng-template>

